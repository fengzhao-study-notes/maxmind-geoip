# GEOIP概述

IP地址定位技术，是通过IP地址来确定其地理位置。


近年来，IP地址定位技术受到越来越多的关注，随着互联网日新月异的发展，市场中的IP地址定位产品存在数据陈旧、定位颗粒度粗糙（仅能达到城市级别）等问题。

即使近年来市场中出现了相比城市级别精度有所提升的IP地址定位产品，但仍无法充分满足市场中用户的需求。

目前在互联网行业基于位置的服务已经成为趋势，基于地理位置的网络应用层出不穷，IP地址定位已广泛应用于网络安全、在线广告投放、在线安全支付、大数据分析、反欺诈风控、大数据征信等领域。

高精准IP地址定位技术在互联网领域中越来越重要。许多研究机构和学者已围绕如何提升IP地址定位技术的定位精度、应用场景等不同问题进行了系统的研究。

### IP定位本质

 IP地址和地理位置并不是直接相关的, 正确的查询 IP 地址所属关系的办法是通过:
 
 逻辑关系：
 
 IP 属于一个地址块, 这个地址块被一个 AS(自治网络) 所拥有, 而 AS 都有一个编号, 即 ASN, 同时 AS 属于一个国家。


IP地理定位本质上是不精确的，地点通常靠近人口中心。

各种GeoIP数据库提供的任何位置不应用于识别特定地址或家庭，使用精度半径作为IP地址返回的纬度和经度坐标的地理定位精度指示，IP地址的实际位置可能在这个半径和经纬度坐标所定义的区域内。



通过输入一个IP地址，解析查询并其信息，比如国家、国家代码、省份、省份代码、城市、邮政编码、经纬度等等信息。

使用在线第三方提供的api：

- ip-api.com
- ip.taotao.com
- 百度地图api
- 新浪 iplookup

使用离线查询方式：
- 纯真库
- MaxMind GeoLite2
- 埃文科技





# MaxMind简介

MaxMind介绍MaxMind成立于2002年，在提供几何定位和在线欺诈工具方面MaxMind处于领先地位。MaxMind是通过GeoIP品牌提供它的几何定位技术的。

GeoIP可以按国家，地域位置甚至精确到城市，对互联网顾客和网站的访客进行精确实时的定位。MaxMind的GeoIP技术为在线业务提供了一个非常价值的的营销工具，并能够帮助定制优化网站以便更好地服务客户。

目前有超过2000位客户在使用GeoIP技术。MaxMind用其行业领先的minFraud服务，旨在帮助商人防止网上信用卡交易中的欺诈行为。

通过其全面的欺诈检测系统，商家可以准确地检测并自动对欺诈性质的“卡不在场交易”进行标注。我们每年检测的电子交易超过2亿笔。

目前，6000多个的电子商务企业通过我们的客户和合作伙伴关系网络共同受益于minFraud这项服务。

MaxMind的客户包括：About.com, AT&T, Dupont, Earthlink, eBay, IBM, Lexis Nexis, Lycos, Match.com, Morgan Stanley, Orbitz, Red Hat, Reed Elsevier, Sony, Walgreens, Wal-Mart, Warner Brothers, WebEx and Yahoo!.

最近需要获取ip地址的地理位置信息（国家地区，经纬度等），就发现了maxmind。

maxmind提供了免费的可在本地部署的geo-ip数据库（GeoLite2）（mmdb以及csv格式），和geo-ip查询api服务

支持ipv4和ipv6的地理信息查询，以及ASN数据库（ip-运营商信息查询）

此前，MaxMind一直提供GeoLite2公开的访问下载地址，但从2019年12月30日开始，MaxMind不再提供GeoLite2公开的访问下载地址，需要用户注册一个MaxMind帐户并获取许可密钥，才能下载GeoLite2数据库。

每个账号每24小时只能下载2000次



 # GEOIP2（GeoLite2）简介
 
 
 
 
 GeoLite2数据库是MaxMind的免费IP地理位置数据库，可与MaxMind的收费GeoIP2数据库相比，但准确性较差。 
 
 - GeoLite2 Country  
 - GeoLite2 City
 - GeoLite2 ASN

 
 城市和ASN数据库（GeoLite2 Country, City, and ASN databases）每周两次更新。 
 
 GeoLite2数据也可以作为Web服务在GeoLite2国家/地区和GeoLite2城市（GeoLite2 Country, City, and ASN databases）Web服务中使用（用户每天每项服务的IP地址查询限制为1000个）。
 
 > 
 
 > P.S 我们不需要官方提供的 web 相关API服务，我们会把整个数据库下载下来自行查询；



## 下载GeoLite2数据库

```shell

mkdir -p /usr/local/etc/geoip2/ && cd /usr/local/etc/geoip2/

# 下载前注意替换成自己的key

# 下载GeoLite2 Country 
wget -O GeoLite2-Country.tar.gz "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=YOUR_LICENSE_KEY&suffix=tar.gz"
# 下载 GeoLite2 City
wget -O  GeoLite2-City.tar.gz "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_LICENSE_KEY&suffix=tar.gz"
# 下载GeoLite2 ASN
wget -O  GeoLite2-ASN.tar.gz "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-ASN&license_key=YOUR_LICENSE_KEY&suffix=tar.gz"


# 解压
ls *.tar.gz | xargs -n1 tar xzvf



```









# mmdp解析和查询

从MaxMind下载的离线IP地理数据库的文件格式是mmdp格式的，要用专门的工具来解析查询。

```shell
# 安装解析工具

# For Amazon Linux, CentOS, Oracle Linux, and RHEL:
$ yum -y install libmaxminddb-devel

# For Debian and Ubuntu:
$ apt-get install libmaxminddb-dev



# 查询
mmdblookup --file /usr/local/etc/geoip2/GeoLite2-Country_20211116/GeoLite2-Country.mmdb   --ip 8.8.8.8

# 获取国家ISO编码
mmdblookup --file /usr/local/etc/geoip2/GeoLite2-Country_20211116/GeoLite2-Country.mmdb   --ip 223.5.5.5 country  iso_code```

